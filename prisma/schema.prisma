generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum UserRole {
  USER
  ADMIN
}

enum CaseStatus {
  RECEBIDA
  EM_ANDAMENTO
  AGUARDANDO_ATUALIZACAO
  CONCLUIDA
}

enum CaseCategory {
  ILUMINACAO_PUBLICA
  BURACO_NA_VIA
  COLETA_DE_LIXO
  OBSTRUCAO_DE_CALCADA
  VAZAMENTO_DE_AGUA
  OUTROS
}

enum EmployeeRole {
  ILUMINACAO_PUBLICA
  BURACO_NA_VIA
  COLETA_DE_LIXO
  OBSTRUCAO_DE_CALCADA
  VAZAMENTO_DE_AGUA
  OUTROS
}

enum CasePhotoKind {
  REPORT
  UPDATE
}

/**
 * =========================
 * MODELS
 * =========================
 */

model User {
  id           String   @id @default(cuid())
  name         String?
  email        String   @unique
  passwordHash String
  role         UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cases      Case[]      @relation("UserCases")
  caseEvents CaseEvent[] @relation("UserCaseEvents")

  @@index([role, createdAt])
}

model Employee {
  id           String        @id @default(cuid())

  // IP / código gerado automaticamente
  employeeCode Int           @unique

  name         String
  cpf          String        @unique

  role         EmployeeRole

  passwordHash String

  isActive     Boolean       @default(true)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  caseEvents   CaseEvent[]   @relation("EmployeeCaseEvents")

  @@index([employeeCode])
  @@index([role])
}


model Case {
  id          String       @id @default(cuid())
  title       String?
  protocol    String       @unique
  category    CaseCategory
  description String
  address     String

  latitude  Decimal? @db.Decimal(9, 6)
  longitude Decimal? @db.Decimal(9, 6)

  status CaseStatus @default(RECEBIDA)

  // ✅ por enquanto opcional pra não quebrar migration com NULL antigo
  userId String?
  user   User? @relation("UserCases", fields: [userId], references: [id], onDelete: SetNull)

  photos CasePhoto[]
  events CaseEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([category, createdAt])
}

model CasePhoto {
  id     String @id @default(cuid())
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  url  String
  kind CasePhotoKind @default(REPORT)

  createdAt DateTime @default(now())

  @@index([caseId, createdAt])
  @@index([kind, createdAt])
}

model CaseEvent {
  id     String @id @default(cuid())
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  // Usuário comum (cidadão / admin)
  authorId String?
  author   User? @relation("UserCaseEvents", fields: [authorId], references: [id], onDelete: SetNull)

  // Funcionário
  employeeId String?
  employee   Employee? @relation("EmployeeCaseEvents", fields: [employeeId], references: [id], onDelete: SetNull)

  status   CaseStatus
  message  String?
  photoUrl String?

  createdAt DateTime @default(now())

  @@index([caseId, createdAt])
  @@index([authorId, createdAt])
  @@index([employeeId, createdAt])
}

